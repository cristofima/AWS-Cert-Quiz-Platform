# CustomMessage Lambda - Cognito Email Trigger

AWS Lambda function that customizes Cognito email templates, specifically for forgot password flow.

## ğŸ“‹ Overview

This Lambda is triggered by Cognito when:

- User requests password reset (`CustomMessage_ForgotPassword`)

Other Cognito events (SignUp, AdminCreateUser) are passed through without modification since they use templates configured directly in `cognito.tf`.

## ğŸ—ï¸ Architecture

```
Cognito ForgotPassword Event
    â†“
CustomMessage Lambda Trigger
    â†“
Generate HTML Email with Reset Link
    â†“
Return to Cognito
    â†“
Email sent to user
```

## ğŸ“¦ Build & Deploy

### Prerequisites

- Node.js 20+
- npm installed
- TypeScript compiler

### Build Process

```powershell
# Install dependencies
npm install

# Compile TypeScript to JavaScript
npm run build

# Verify compilation
ls index.js  # Should exist
```

**âš ï¸ Important**: Must build **before** running `terraform apply` because Terraform packages the compiled JavaScript into a ZIP file.

### Project Structure

```
custom-message/
â”œâ”€â”€ index.ts          # TypeScript source code
â”œâ”€â”€ index.js          # Compiled JavaScript (generated by npm run build)
â”œâ”€â”€ package.json      # Dependencies & scripts
â”œâ”€â”€ tsconfig.json     # TypeScript configuration
â””â”€â”€ node_modules/     # Dependencies (npm install)
```

### Deployment

```powershell
# From project root
cd lambdas/custom-message
npm install
npm run build

# Deploy with Terraform
cd ../../infrastructure/terraform
terraform apply -target='aws_lambda_function.custom_message'
```

Or use the build script:

```powershell
# From project root
.\scripts\build-lambdas.ps1
cd infrastructure/terraform
terraform apply
```

## ğŸ”§ Configuration

### Environment Variables

Set automatically by Terraform:

- `FRONTEND_URL`: Base URL for reset links (e.g., `http://localhost:3000`)
- `LOG_LEVEL`: Logging verbosity (`INFO`, `DEBUG`, `ERROR`)

### Lambda Settings

- **Runtime**: Node.js 20.x
- **Handler**: `index.handler`
- **Timeout**: 10 seconds (Cognito CustomMessage has strict limits)
- **Memory**: 256 MB

## ğŸ§ª Testing

### Local Testing

Create a test event in `test-event.json`:

```json
{
  "version": "1",
  "triggerSource": "CustomMessage_ForgotPassword",
  "region": "us-east-1",
  "userPoolId": "us-east-1_XNLodSkoE",
  "userName": "testuser",
  "request": {
    "userAttributes": {
      "email": "test@example.com",
      "sub": "12345"
    },
    "codeParameter": "123456"
  },
  "response": {}
}
```

Run locally (requires AWS SDK setup):

```powershell
node -e "const handler = require('./index').handler; handler(require('./test-event.json'), {}, console.log)"
```

### AWS Testing

```powershell
# Invoke from AWS CLI
aws lambda invoke \
  --function-name cert-quiz-custom-message-dev \
  --payload file://test-event.json \
  --region us-east-1 \
  output.json

cat output.json
```

### End-to-End Testing

```powershell
# 1. Request password reset
curl -X POST http://localhost:3000/api/auth/forgot-password \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com"}'

# 2. Check Lambda logs
aws logs tail /aws/lambda/cert-quiz-custom-message-dev --follow

# 3. Check email for reset link
```

## ğŸ“Š Monitoring

### CloudWatch Logs

```powershell
# Tail logs in real-time
aws logs tail /aws/lambda/cert-quiz-custom-message-dev --follow --region us-east-1

# Filter for errors
aws logs filter-log-events \
  --log-group-name /aws/lambda/cert-quiz-custom-message-dev \
  --filter-pattern "ERROR" \
  --region us-east-1
```

### Metrics

Monitor in CloudWatch:

- **Invocations**: Number of times triggered
- **Errors**: Failed executions
- **Duration**: Execution time (should be <1 second)
- **Throttles**: Rate limit hits

## ğŸ› Troubleshooting

### Error: "Cannot find module 'index'"

**Cause**: TypeScript not compiled

**Fix**:

```powershell
npm run build
terraform apply -target='aws_lambda_function.custom_message'
```

### Error: "FRONTEND_URL is not defined"

**Cause**: Environment variable not set in Terraform

**Fix**: Set in `terraform.tfvars`:

```hcl
frontend_url = "http://localhost:3000"
```

### Email not customized

**Cause**: Lambda not triggered or failed

**Fix**:

1. Check Lambda is attached to Cognito:

   ```powershell
   aws cognito-idp describe-user-pool --user-pool-id us-east-1_XNLodSkoE | jq '.UserPool.LambdaConfig'
   ```

2. Check CloudWatch logs for errors

3. Verify Lambda permission exists:
   ```powershell
   aws lambda get-policy --function-name cert-quiz-custom-message-dev
   ```

## ğŸ“š References

- [AWS Cognito Lambda Triggers](https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-lambda-custom-message.html)
- [CustomMessage Trigger Event](https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-lambda-custom-message.html#cognito-user-pools-lambda-trigger-syntax-custom-message)
- [Lambda Node.js Runtime](https://docs.aws.amazon.com/lambda/latest/dg/lambda-nodejs.html)

## ğŸ”„ Development Workflow

1. **Edit code**: Modify `index.ts`
2. **Compile**: Run `npm run build`
3. **Test locally**: Run test event
4. **Deploy**: Run `terraform apply -target='aws_lambda_function.custom_message'`
5. **Test in AWS**: Trigger forgot password flow
6. **Check logs**: Monitor CloudWatch logs
7. **Iterate**: Repeat as needed

## ğŸ“ Notes

- **Why TypeScript?**: Type safety, better IDE support, catches errors at compile time
- **Why compile in place?**: Simpler for Terraform ZIP packaging (no complex directory structure)
- **Why exclude .ts files?**: Reduces ZIP size, Lambda only needs .js files
- **SignUp/AdminCreateUser**: Don't need Lambda customization - configured directly in Cognito via `verification_message_template` and `invite_message_template`

---

**Last Updated**: November 10, 2025
